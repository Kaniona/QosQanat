<!DOCTYPE html>
<html lang="kk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–π—Ç–∏–Ω–≥ | QosQanat</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="home.html" class="navbar-brand">
                <img src="../assets/images/logo.png" alt="QosQanat">
                <span>QosQanat</span>
            </a>

            <ul class="navbar-menu">
                <li><a href="home.html" class="navbar-link">–ë–∞—Å—Ç—ã</a></li>
                <li><a href="learning.html" class="navbar-link">–û“õ—É</a></li>
                <li><a href="rating.html" class="navbar-link active">–†–µ–π—Ç–∏–Ω–≥</a></li>
                <li><a href="shop.html" class="navbar-link">–î“Ø–∫–µ–Ω</a></li>
                <li><a href="profile.html" class="navbar-link">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
                <li><button onclick="logout()" class="btn btn-sm btn-outline">–®—ã“ì—É</button></li>
            </ul>
        </div>
    </nav>

    <div class="container py-lg">
        <h1 class="text-center mb-xl animate-fade-in">üèÜ –†–µ–π—Ç–∏–Ω–≥</h1>

        <!-- Rating Tabs -->
        <div class="rating-tabs mb-lg">
            <button class="rating-tab active" onclick="switchRatingTab('city')">
                üèôÔ∏è “ö–∞–ª–∞ –±–æ–π—ã–Ω—à–∞
            </button>
            <button class="rating-tab" onclick="switchRatingTab('national')">
                üá∞üáø “ö–∞–∑–∞“õ—Å—Ç–∞–Ω –±–æ–π—ã–Ω—à–∞
            </button>
        </div>

        <!-- City Rating View -->
        <div id="city-rating-view" class="rating-view">
            <div class="card mb-lg">
                <div class="card-body">
                    <div class="form-group">
                        <label>“ö–∞–ª–∞–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑:</label>
                        <select class="form-control" id="city-select" onchange="loadCityRating()">
                            <option value="–ê—Å—Ç–∞–Ω–∞">–ê—Å—Ç–∞–Ω–∞</option>
                            <option value="–ê–ª–º–∞—Ç—ã">–ê–ª–º–∞—Ç—ã</option>
                            <option value="–®—ã–º–∫–µ–Ω—Ç">–®—ã–º–∫–µ–Ω—Ç</option>
                            <option value="“ö–∞—Ä–∞“ì–∞–Ω–¥—ã">“ö–∞—Ä–∞“ì–∞–Ω–¥—ã</option>
                            <option value="–ê“õ—Ç”©–±–µ">–ê“õ—Ç”©–±–µ</option>
                            <option value="–¢–∞—Ä–∞–∑">–¢–∞—Ä–∞–∑</option>
                            <option value="–ü–∞–≤–ª–æ–¥–∞—Ä">–ü–∞–≤–ª–æ–¥–∞—Ä</option>
                            <option value="–°–µ–º–µ–π">–°–µ–º–µ–π</option>
                            <option value="”®—Å–∫–µ–º–µ–Ω">”®—Å–∫–µ–º–µ–Ω</option>
                            <option value="–û—Ä–∞–ª">–û—Ä–∞–ª</option>
                            <option value="–ê“õ—Ç–∞—É">–ê“õ—Ç–∞—É</option>
                            <option value="–ê—Ç—ã—Ä–∞—É">–ê—Ç—ã—Ä–∞—É</option>
                            <option value="“ö–æ—Å—Ç–∞–Ω–∞–π">“ö–æ—Å—Ç–∞–Ω–∞–π</option>
                            <option value="“ö—ã–∑—ã–ª–æ—Ä–¥–∞">“ö—ã–∑—ã–ª–æ—Ä–¥–∞</option>
                            <option value="–ü–µ—Ç—Ä–æ–ø–∞–≤–ª">–ü–µ—Ç—Ä–æ–ø–∞–≤–ª</option>
                            <option value="–¢–∞–ª–¥—ã“õ–æ—Ä“ì–∞–Ω">–¢–∞–ª–¥—ã“õ–æ—Ä“ì–∞–Ω</option>
                            <option value="–¢“Ø—Ä–∫—ñ—Å—Ç–∞–Ω">–¢“Ø—Ä–∫—ñ—Å—Ç–∞–Ω</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div id="city-leaderboard"></div>
                </div>
            </div>
        </div>

        <!-- National Rating View -->
        <div id="national-rating-view" class="rating-view" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div id="national-leaderboard"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/gamification.js"></script>
    <script>
        checkAuth();

        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const userCity = user.city || '–ê—Å—Ç–∞–Ω–∞';

        // Set user's city as selected
        document.getElementById('city-select').value = userCity;

        // Demo leaderboard data (replace with API call later)
        const demoLeaderboard = {
            '–ê—Å—Ç–∞–Ω–∞': [
                { rank: 1, fullName: '–ù“±—Ä—Å“±–ª—Ç–∞–Ω ”ò–±–¥—ñ“ì–∞–ª–∏–µ–≤', school: '‚Ññ45 –º–µ–∫—Ç–µ–±—ñ', points: 950, level: 4, isCurrentUser: false },
                { rank: 2, fullName: '–ê–π–¥–∞—Ä –°–µ—Ä—ñ–∫–±–∞–µ–≤', school: '‚Ññ1 –ù–ó–ú', points: 850, level: 4, isCurrentUser: false },
                { rank: 3, fullName: '–î–∏–Ω–∞—Ä–∞ “ö–∞—Å—ã–º–æ–≤–∞', school: '‚Ññ28 –≥–∏–º–Ω–∞–∑–∏—è—Å—ã', points: 720, level: 3, isCurrentUser: false },
                { rank: 4, fullName: '–ê—Å—Ö–∞—Ç –¢“±—Ä—Å—ã–Ω–æ–≤', school: '‚Ññ12 –º–µ–∫—Ç–µ–±—ñ', points: 680, level: 3, isCurrentUser: false },
                { rank: 5, fullName: '”ò—Å–µ–º –ù“±—Ä–ª–∞–Ω–æ–≤–∞', school: '‚Ññ3 –≥–∏–º–Ω–∞–∑–∏—è—Å—ã', points: 650, level: 3, isCurrentUser: false },
            ],
            '–ê–ª–º–∞—Ç—ã': [
                { rank: 1, fullName: '–ñ–∞–Ω–∞—Ä “ö–∞–ª–∏–µ–≤–∞', school: '‚Ññ28 –≥–∏–º–Ω–∞–∑–∏—è—Å—ã', points: 920, level: 4, isCurrentUser: false },
                { rank: 2, fullName: '–ë–µ–∫–∑–∞—Ç –ú“±—Ä–∞—Ç–æ–≤', school: '‚Ññ1 –¢–ê–õ', points: 880, level: 4, isCurrentUser: false },
                { rank: 3, fullName: '”ò–ª–∏—è –°–µ–π—ñ—Ç–æ–≤–∞', school: '‚Ññ121 –º–µ–∫—Ç–µ–±—ñ', points: 750, level: 3, isCurrentUser: false },
            ],
            '–®—ã–º–∫–µ–Ω—Ç': [
                { rank: 1, fullName: '–ê–π–≥–µ—Ä—ñ–º –¢–µ–º—ñ—Ä–±–µ–∫–æ–≤–∞', school: '‚Ññ12 –≥–∏–º–Ω–∞–∑–∏—è—Å—ã', points: 850, level: 4, isCurrentUser: false },
                { rank: 2, fullName: '–î”ô—É—Ä–µ–Ω ”ò–±–¥—ñ“õ–∞–¥—ã—Ä–æ–≤', school: '‚Ññ45 –º–µ–∫—Ç–µ–±—ñ', points: 780, level: 3, isCurrentUser: false },
            ],
            '“ö–∞—Ä–∞“ì–∞–Ω–¥—ã': [
                { rank: 1, fullName: '–ï—Ä–ª–∞–Ω –î–æ—Å–º“±—Ö–∞–º–±–µ—Ç–æ–≤', school: '‚Ññ7 –º–µ–∫—Ç–µ–±—ñ', points: 860, level: 4, isCurrentUser: false },
                { rank: 2, fullName: '–ú–∞–¥–∏–Ω–∞ –ï—Å–µ–Ω–æ–≤–∞', school: '‚Ññ34 –≥–∏–º–Ω–∞–∑–∏—è—Å—ã', points: 790, level: 3, isCurrentUser: false },
            ]
        };

        // Add current user to their city's leaderboard
        const currentStats = JSON.parse(localStorage.getItem('userStats') || '{"level":1,"intellectPoints":0,"coins":20}');
        if (user.fullName && user.city && demoLeaderboard[user.city]) {
            const existingIndex = demoLeaderboard[user.city].findIndex(u => u.fullName === user.fullName);
            if (existingIndex === -1) {
                demoLeaderboard[user.city].push({
                    rank: 0,
                    fullName: user.fullName,
                    school: user.school || '–ú–µ–∫—Ç–µ–ø',
                    points: currentStats.intellectPoints,
                    level: currentStats.level,
                    isCurrentUser: true
                });
            }
        }

        // Sort and recalculate ranks
        Object.keys(demoLeaderboard).forEach(city => {
            demoLeaderboard[city].sort((a, b) => b.points - a.points);
            demoLeaderboard[city].forEach((student, index) => {
                student.rank = index + 1;
            });
        });

        function switchRatingTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.rating-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide rating views
            if (tab === 'city') {
                document.getElementById('city-rating-view').style.display = 'block';
                document.getElementById('national-rating-view').style.display = 'none';
                loadCityRating();
            } else {
                document.getElementById('city-rating-view').style.display = 'none';
                document.getElementById('national-rating-view').style.display = 'block';
                loadNationalRating();
            }
        }

        function loadCityRating() {
            const selectedCity = document.getElementById('city-select').value;
            const leaderboard = demoLeaderboard[selectedCity] || [];

            if (leaderboard.length === 0) {
                document.getElementById('city-leaderboard').innerHTML = `
                    <div class="alert alert-info text-center">
                        <p>–ë“±–ª “õ–∞–ª–∞–¥–∞ ”ô–ª—ñ –æ“õ—É—à—ã–ª–∞—Ä –∂–æ“õ</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="leaderboard-table"><table class="table">';
            html += `
                <thead>
                    <tr>
                        <th>–û—Ä—ã–Ω</th>
                        <th>–ê—Ç—ã-–∂”©–Ω—ñ</th>
                        <th>–ú–µ–∫—Ç–µ–ø</th>
                        <th>–î–µ“£–≥–µ–π</th>
                        <th>“∞–ø–∞–π</th>
                    </tr>
                </thead>
                <tbody>
            `;

            leaderboard.forEach(student => {
                const medal = student.rank === 1 ? 'ü•á' : student.rank === 2 ? 'ü•à' : student.rank === 3 ? 'ü•â' : '';
                const highlightClass = student.isCurrentUser ? 'leaderboard-current-user' : '';

                html += `
                    <tr class="${highlightClass}">
                        <td><strong>${medal} ${student.rank}</strong></td>
                        <td>${student.fullName} ${student.isCurrentUser ? '(–°—ñ–∑)' : ''}</td>
                        <td>${student.school}</td>
                        <td>
                            <span class="level-badge">‚≠ê ${student.level}</span>
                        </td>
                        <td><strong>${student.points}</strong></td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('city-leaderboard').innerHTML = html;
        }

        function loadNationalRating() {
            // Combine all city leaderboards
            let allStudents = [];
            Object.values(demoLeaderboard).forEach(cityLeaderboard => {
                allStudents = allStudents.concat(cityLeaderboard.map(s => ({ ...s, city: s.city })));
            });

            // Add city info
            Object.keys(demoLeaderboard).forEach(city => {
                demoLeaderboard[city].forEach(student => {
                    student.city = city;
                });
            });

            // Flatten and sort
            allStudents = [];
            Object.entries(demoLeaderboard).forEach(([city, students]) => {
                students.forEach(student => {
                    allStudents.push({ ...student, city });
                });
            });

            allStudents.sort((a, b) => b.points - a.points);
            allStudents.forEach((student, index) => {
                student.rank = index + 1;
            });

            // Take top 50
            const topStudents = allStudents.slice(0, 50);

            let html = '<div class="leaderboard-table"><table class="table">';
            html += `
                <thead>
                    <tr>
                        <th>–û—Ä—ã–Ω</th>
                        <th>–ê—Ç—ã-–∂”©–Ω—ñ</th>
                        <th>“ö–∞–ª–∞</th>
                        <th>–ú–µ–∫—Ç–µ–ø</th>
                        <th>–î–µ“£–≥–µ–π</th>
                        <th>“∞–ø–∞–π</th>
                    </tr>
                </thead>
                <tbody>
            `;

            topStudents.forEach(student => {
                const medal = student.rank === 1 ? 'ü•á' : student.rank === 2 ? 'ü•à' : student.rank === 3 ? 'ü•â' : '';
                const highlightClass = student.isCurrentUser ? 'leaderboard-current-user' : '';

                html += `
                    <tr class="${highlightClass}">
                        <td><strong>${medal} ${student.rank}</strong></td>
                        <td>${student.fullName} ${student.isCurrentUser ? '(–°—ñ–∑)' : ''}</td>
                        <td>${student.city}</td>
                        <td>${student.school}</td>
                        <td>
                            <span class="level-badge">‚≠ê ${student.level}</span>
                        </td>
                        <td><strong>${student.points}</strong></td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('national-leaderboard').innerHTML = html;
        }

        // Load city rating by default
        loadCityRating();
    </script>
</body>

</html>